name: AI Critic (PR) - Gemini

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }} HEAD | head -n 1000)

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "diff<<$EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Ask AI critic (Gemini)
        id: ai-response
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DIFF: ${{ steps.diff.outputs.diff }}
        run: |
          SYSTEM_PROMPT="You are a helpful code review assistant for a Python Shiny dashboard project.
          Your task is to review pull request code changes for quality, correctness, and maintainability.

          Pay special attention to:
          - Shiny reactive patterns (reactive.Calc, reactive.Effect, reactive.Value)
          - UI layout structure and component usage
          - Data wrangling logic and pandas/polars usage
          - Separation of concerns between UI and server logic

          If the code is well-written, efficient, and follows best practices, acknowledge the good work and highlight what was done well.

          If the code has issues—such as bugs, inefficiencies, poor readability, or missing error handling—provide constructive feedback with specific suggestions for improvement.

          Be respectful and supportive—remember that code review is a learning opportunity for everyone involved.
          Focus on meaningful improvements rather than nitpicking style preferences.
          Always respond with ready-to-use markdown content."

          jq -n \
            --arg system_prompt "$SYSTEM_PROMPT" \
            --arg diff "$DIFF" \
            '{
              contents: [{ parts: [{ text: ("Code Changes:\n\n```diff\n" + $diff + "\n```") }] }],
              system_instruction: { parts: [{ text: $system_prompt }] }
            }' > payload.json

          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-goog-api-key: $GEMINI_API_KEY" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent")

          REVIEW=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: Failed to get response from Gemini. Check logs for details."')

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "response<<$EOF" >> "$GITHUB_OUTPUT"
          echo "$REVIEW" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Comment results on the PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.ai-response.outputs.response }}
